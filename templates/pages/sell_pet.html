{% extends 'base.html' %}
{% load static %}

{% block title %}Sell Your Pet - PetPal{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/sell_pet.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="sell-pet-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="sell-pet-header text-center mb-5">
                    <h1 class="display-4 text-primary">Sell Your Pet</h1>
                    <p class="lead text-muted">Find a loving home for your pet by listing it on our marketplace</p>
                </div>

                <div class="card shadow-lg">
                    <div class="card-body p-5">
                        <form method="post" enctype="multipart/form-data" class="pet-form" id="pet-form">
                            {% csrf_token %}
                            
                            <!-- Basic Information -->
                            <div class="form-section mb-5">
                                <h3 class="section-title">Basic Information</h3>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.name.id_for_label }}" class="form-label">Pet Name *</label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                            <div class="text-danger small">{{ form.name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.breed.id_for_label }}" class="form-label">Breed *</label>
                                        {{ form.breed }}
                                        {% if form.breed.errors %}
                                            <div class="text-danger small">{{ form.breed.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.age.id_for_label }}" class="form-label">Age *</label>
                                        {{ form.age }}
                                        {% if form.age.errors %}
                                            <div class="text-danger small">{{ form.age.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.gender.id_for_label }}" class="form-label">Gender *</label>
                                        {{ form.gender }}
                                        {% if form.gender.errors %}
                                            <div class="text-danger small">{{ form.gender.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.price.id_for_label }}" class="form-label">Price (USD) *</label>
                                        {{ form.price }}
                                        {% if form.price.errors %}
                                            <div class="text-danger small">{{ form.price.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">Description *</label>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                        <div class="text-danger small">{{ form.description.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Photos -->
                            <div class="form-section mb-5">
                                <h3 class="section-title">Photos</h3>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.image.id_for_label }}" class="form-label">Main Photo *</label>
                                        {{ form.image }}
                                        {% if form.image.errors %}
                                            <div class="text-danger small">{{ form.image.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.image2.id_for_label }}" class="form-label">Additional Photo</label>
                                        {{ form.image2 }}
                                        {% if form.image2.errors %}
                                            <div class="text-danger small">{{ form.image2.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.image3.id_for_label }}" class="form-label">Additional Photo</label>
                                        {{ form.image3 }}
                                        {% if form.image3.errors %}
                                            <div class="text-danger small">{{ form.image3.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Pet Details -->
                            <div class="form-section mb-5">
                                <h3 class="section-title">Pet Details</h3>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.weight.id_for_label }}" class="form-label">Weight</label>
                                        {{ form.weight }}
                                        {% if form.weight.errors %}
                                            <div class="text-danger small">{{ form.weight.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.color.id_for_label }}" class="form-label">Color/Markings</label>
                                        {{ form.color }}
                                        {% if form.color.errors %}
                                            <div class="text-danger small">{{ form.color.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            {{ form.vaccination_status }}
                                            <label class="form-check-label" for="{{ form.vaccination_status.id_for_label }}">
                                                Pet is vaccinated
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            {{ form.health_certificate }}
                                            <label class="form-check-label" for="{{ form.health_certificate.id_for_label }}">
                                                Has health certificate
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Location -->
                            <div class="form-section mb-5">
                                <h3 class="section-title">Location</h3>
                                <p class="text-muted mb-3">Click on the map or search for your location to set where your pet is located.</p>
                                
                                <!-- Location Search -->
                                <div class="search-controls">
                                    <label class="form-label">Search Location</label>
                                    <div class="input-group">
                                        <input type="text" id="location-search" class="form-control" placeholder="Search for your address or city...">
                                        <button type="button" id="search-btn" class="btn btn-outline-secondary">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button type="button" id="current-location-btn" class="btn btn-outline-primary">
                                            <i class="fas fa-location-arrow"></i> Use Current Location
                                        </button>
                                    </div>
                                </div>

                                <!-- Interactive Map -->
                                <div class="map-container">
                                    <div id="location-map"></div>
                                </div>

                                <div class="location-info">
                                    <small><i class="fas fa-info-circle me-1"></i>Click anywhere on the map to set your pet's location</small>
                                </div>

                                <!-- Location Details -->
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.address.id_for_label }}" class="form-label">Selected Address</label>
                                        {{ form.address }}
                                        {% if form.address.errors %}
                                            <div class="text-danger small">{{ form.address.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.city.id_for_label }}" class="form-label">City *</label>
                                        {{ form.city }}
                                        {% if form.city.errors %}
                                            <div class="text-danger small">{{ form.city.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.state.id_for_label }}" class="form-label">State/Province *</label>
                                        {{ form.state }}
                                        {% if form.state.errors %}
                                            <div class="text-danger small">{{ form.state.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Hidden coordinate fields -->
                                {{ form.latitude }}
                                {{ form.longitude }}
                            </div>

                            <!-- Submit Button -->
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg px-5" id="submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>Submit for Review
                                </button>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Your pet listing will be reviewed by our admin team before appearing in the marketplace.
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Simple map initialization - following your working about page pattern
let map;
let marker = null;

// Form submission handling
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map first
    setTimeout(() => {
        initializeMap();
    }, 500);

    // Handle form submission
    const form = document.getElementById('pet-form');
    const submitBtn = document.getElementById('submit-btn');
    
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            console.log('Form submitted');
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            
            // Let the form submit normally - don't prevent default
            // The disabled state and loading text will show until page reloads/redirects
        });
    }
});

function initializeMap() {
    console.log('Initializing map...');
    
    // Initialize map - simple and direct like your about page
    map = L.map('location-map').setView([27.7172, 85.3240], 13); // Default to Kathmandu, Nepal
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(map);

    console.log('Map initialized');

    // Get form fields using simple selectors
    const latField = document.querySelector('input[name="latitude"]');
    const lngField = document.querySelector('input[name="longitude"]');
    const addressField = document.querySelector('input[name="address"]') || document.querySelector('textarea[name="address"]');
    const cityField = document.querySelector('input[name="city"]');
    const stateField = document.querySelector('input[name="state"]');
    const searchInput = document.getElementById('location-search');
    const searchBtn = document.getElementById('search-btn');
    const currentLocationBtn = document.getElementById('current-location-btn');

    console.log('Form fields found:', {
        latField: !!latField,
        lngField: !!lngField,
        addressField: !!addressField,
        cityField: !!cityField,
        stateField: !!stateField
    });

    // Function to update location
    function updateLocation(lat, lng, address = '') {
        console.log(`Updating location: ${lat}, ${lng}`);
        
        // Update marker
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker([lat, lng]).addTo(map);
        
        // Update form fields
        if (latField) latField.value = lat.toFixed(8);
        if (lngField) lngField.value = lng.toFixed(8);
        
        // Reverse geocode to get address
        if (!address) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        if (addressField) addressField.value = data.display_name;
                        
                        // Extract city and state
                        const addressParts = data.address || {};
                        const city = addressParts.city || addressParts.town || addressParts.village || addressParts.suburb || '';
                        const state = addressParts.state || addressParts.region || '';
                        
                        if (city && cityField) cityField.value = city;
                        if (state && stateField) stateField.value = state;
                        
                        console.log('Address updated:', data.display_name);
                    }
                })
                .catch(error => {
                    console.error('Reverse geocoding error:', error);
                    if (addressField) addressField.value = `Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                });
        } else {
            if (addressField) addressField.value = address;
        }
    }

    // Map click event
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        updateLocation(lat, lng);
    });

    // Search functionality
    function performSearch() {
        const query = searchInput ? searchInput.value.trim() : '';
        if (!query) {
            alert('Please enter a location to search');
            return;
        }

        if (searchBtn) {
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    map.setView([lat, lng], 15);
                    updateLocation(lat, lng, result.display_name);
                } else {
                    alert('Location not found. Please try a different search term.');
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                alert('Search failed. Please try again.');
            })
            .finally(() => {
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = '<i class="fas fa-search"></i>';
                }
            });
    }

    // Search button click
    if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
    }

    // Search on Enter key
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
    }

    // Current location button
    if (currentLocationBtn) {
        currentLocationBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }
            
            currentLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
            currentLocationBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    map.setView([lat, lng], 15);
                    updateLocation(lat, lng);
                    
                    currentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use Current Location';
                    currentLocationBtn.disabled = false;
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    alert('Unable to get your current location. Please search manually or click on the map.');
                    currentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use Current Location';
                    currentLocationBtn.disabled = false;
                }
            );
        });
    }

    // Load existing location if editing
    const existingLat = latField ? latField.value : '';
    const existingLng = lngField ? lngField.value : '';
    if (existingLat && existingLng && !isNaN(existingLat) && !isNaN(existingLng)) {
        const lat = parseFloat(existingLat);
        const lng = parseFloat(existingLng);
        console.log(`Loading existing location: ${lat}, ${lng}`);
        map.setView([lat, lng], 15);
        marker = L.marker([lat, lng]).addTo(map);
    }
}
</script>
{% endblock %}