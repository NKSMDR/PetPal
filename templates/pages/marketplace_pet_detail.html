{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ pet.breed.name }} - {{ pet.get_gender_display }} - Marketplace Pet{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/marketplace_pet_detail.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'marketplace' %}">Marketplace</a></li>
            <li class="breadcrumb-item active">{{ pet.breed.name }} - {{ pet.get_gender_display }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Pet Images -->
        <div class="col-lg-6">
            <div class="pet-images">
                <div class="main-image-container mb-3" onclick="openLightbox(0)" style="cursor: pointer;">
                    {% if pet.image %}
                        <img src="{{ pet.image.url }}" alt="{{ pet.breed.name }} - {{ pet.get_gender_display }}" class="img-fluid rounded main-pet-image" id="main-image">
                    {% else %}
                        <img src="{% static 'images/default-pet.jpg' %}" alt="No image" class="img-fluid rounded main-pet-image" id="main-image">
                    {% endif %}
                    <div class="image-count-indicator">
                        <i class="fas fa-images"></i>
                        <span id="current-image-number">1</span> / <span id="total-images">{% if pet.image3 %}3{% elif pet.image2 %}2{% else %}1{% endif %}</span>
                    </div>
                </div>
                
                <!-- Additional Images -->
                <div class="additional-images d-flex gap-2">
                    {% if pet.image %}
                        <div class="additional-image-container" onclick="changeMainImage('{{ pet.image.url }}', 0); event.stopPropagation();" ondblclick="openLightbox(0)">
                            <img src="{{ pet.image.url }}" alt="{{ pet.breed.name }} - {{ pet.get_gender_display }}" class="img-thumbnail additional-image" data-index="0">
                        </div>
                    {% endif %}
                    {% if pet.image2 %}
                        <div class="additional-image-container" onclick="changeMainImage('{{ pet.image2.url }}', 1); event.stopPropagation();" ondblclick="openLightbox(1)">
                            <img src="{{ pet.image2.url }}" alt="{{ pet.breed.name }} - {{ pet.get_gender_display }}" class="img-thumbnail additional-image" data-index="1">
                        </div>
                    {% endif %}
                    {% if pet.image3 %}
                        <div class="additional-image-container" onclick="changeMainImage('{{ pet.image3.url }}', 2); event.stopPropagation();" ondblclick="openLightbox(2)">
                            <img src="{{ pet.image3.url }}" alt="{{ pet.breed.name }} - {{ pet.get_gender_display }}" class="img-thumbnail additional-image" data-index="2">
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pet Details -->
        <div class="col-lg-6">
            <div class="pet-info">
                <!-- Marketplace Badge -->
                <div class="marketplace-badge mb-3">
                    <span class="badge bg-success">Community Marketplace</span>
                </div>

                <!-- Pet Name and Price -->
                <h1 class="pet-name">{{ pet.breed.name }} - {{ pet.get_gender_display }}</h1>
                <div class="pet-price mb-3">
                    <span class="price">NRS {{ pet.price }}</span>
                </div>

                <!-- Listed Date -->
                <div class="listing-date mb-4">
                    {% if pet.created_at %}
                        {% with time_ago=pet.created_at|timesince %}
                            {% if "minute" in time_ago or "hour" in time_ago or time_ago|slice:":1" == "0" %}
                                <span class="badge listing-badge new-listing">
                                    <i class="fas fa-star me-1"></i>New Listing
                                </span>
                                <span class="text-muted ms-2" style="font-size: 0.9rem;">
                                    <i class="far fa-clock me-1"></i>{{ time_ago }} ago
                                </span>
                            {% elif "day" in time_ago and time_ago|slice:":1" == "1" %}
                                <span class="listing-info">
                                    <i class="far fa-clock me-1"></i>Listed {{ time_ago }} ago
                                </span>
                            {% else %}
                                <span class="listing-info">
                                    <i class="far fa-clock me-1"></i>Listed {{ time_ago }} ago
                                </span>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>

                <!-- Seller Information -->
                <div class="seller-info card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Seller Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-6">
                                <strong>Name:</strong> {{ pet.seller.get_full_name|default:pet.seller.username }}
                            </div>
                            <div class="col-sm-6">
                                <strong>Location:</strong> {{ pet.city }}, {{ pet.state }}
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary btn-sm" onclick="contactSeller()">
                                <i class="fas fa-envelope"></i> Contact Seller
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pet Basic Info -->
                <div class="pet-details card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-paw"></i> Pet Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-6 mb-2">
                                <strong>Breed:</strong> {{ pet.breed.name }}
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>Age:</strong> {{ pet.age }} months
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>Gender:</strong> {{ pet.get_gender_display }}
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>Weight:</strong> {{ pet.weight|default:"Not specified" }}
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>Color:</strong> {{ pet.color|default:"Not specified" }}
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>Vaccination:</strong> 
                                <span class="badge bg-{{ pet.vaccination_status|yesno:'success,warning' }}">
                                    {{ pet.vaccination_status|yesno:'Vaccinated,Not Vaccinated' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Information -->
                {% if pet.health_certificate %}
                <div class="health-info card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-heart"></i> Health Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="health-badge mb-3">
                            <span class="badge bg-success"><i class="fas fa-check-circle"></i> Health Certificate Available</span>
                        </div>
                        {% if pet.health_certificate_file %}
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary btn-sm" onclick="viewHealthCertificate('{{ pet.health_certificate_file.url }}')">
                                <i class="fas fa-eye me-1"></i>View Certificate
                            </button>
                            <a href="{{ pet.health_certificate_file.url }}" download class="btn btn-success btn-sm">
                                <i class="fas fa-download me-1"></i>Download
                            </a>
                        </div>
                        {% else %}
                        <p class="text-muted small mb-0">
                            <i class="fas fa-info-circle me-1"></i>Certificate file not uploaded yet. Contact seller for details.
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Description -->
                {% if pet.description %}
                <div class="pet-description card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> About this {{ pet.breed.name }}</h5>
                    </div>
                    <div class="card-body">
                        <p>{{ pet.description|linebreaks }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Location Map Section -->
    <div class="location-map-section">
        <h3 class="mb-3">Location & Route</h3>
        <div class="mb-2">
            <button class="btn btn-sm btn-primary" onclick="showRoute()">
                <i class="fas fa-route"></i> Show Route from My Location
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearRoute()">
                <i class="fas fa-times"></i> Clear Route
            </button>
        </div>
        <div class="location-map-container">
            <div id="location-map" style="width: 100%; height: 100%;"></div>
        </div>
        <div class="location-info-card">
            <div class="location-detail">
                <i class="fas fa-map-marker-alt text-danger"></i>
                <span><strong>Pet Location:</strong> {{ pet.city }}, {{ pet.state }}</span>
            </div>
            {% if pet.address %}
            <div class="location-detail">
                <i class="fas fa-home"></i>
                <span>{{ pet.address }}</span>
            </div>
            {% endif %}
            <div id="distance-info" class="location-detail" style="display: none;">
                <i class="fas fa-ruler"></i>
                <span id="distance-text"></span>
            </div>
            <div id="duration-info" class="location-detail" style="display: none;">
                <i class="fas fa-clock"></i>
                <span id="duration-text"></span>
            </div>
        </div>
    </div>

    <!-- Related Pets -->
    {% if related_pets %}
    <div class="related-pets mt-5">
        <h3 class="mb-4">More {{ pet.breed.name }}s in Marketplace</h3>
        <div class="row">
            {% for related_pet in related_pets %}
            <div class="col-md-3 mb-4">
                <div class="card pet-card">
                    <div class="card-img-container">
                        {% if related_pet.image %}
                            <img src="{{ related_pet.image.url }}" class="card-img-top" alt="{{ related_pet.breed.name }} - {{ related_pet.get_gender_display }}">
                        {% else %}
                            <img src="{% static 'images/default-pet.jpg' %}" class="card-img-top" alt="No image">
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">{{ related_pet.breed.name }} - {{ related_pet.get_gender_display }}</h6>
                        <p class="card-text">
                            <small class="text-muted">{{ related_pet.age }} months • {{ related_pet.get_gender_display }}</small><br>
                            <strong class="text-success">NRS {{ related_pet.price }}</strong>
                        </p>
                        <a href="{% url 'marketplace_pet_detail' related_pet.pk %}" class="btn btn-sm btn-outline-primary">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Image Lightbox Modal -->
<div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
    <span class="lightbox-close" onclick="closeLightbox(event)">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
    <button class="lightbox-nav lightbox-prev" onclick="changeLightboxImage(-1); event.stopPropagation();">
        <i class="fas fa-chevron-left"></i>
    </button>
    <button class="lightbox-nav lightbox-next" onclick="changeLightboxImage(1); event.stopPropagation();">
        <i class="fas fa-chevron-right"></i>
    </button>
    <div class="lightbox-counter" id="lightbox-counter"></div>
</div>

<!-- Health Certificate Viewer Modal -->
<div class="lightbox" id="certificate-modal" onclick="closeCertificateModal(event)">
    <span class="lightbox-close" onclick="closeCertificateModal(event)">&times;</span>
    <div class="certificate-content">
        <div class="certificate-header">
            <h4><i class="fas fa-certificate me-2"></i>Health Certificate</h4>
        </div>
        <div class="certificate-viewer" id="certificate-viewer"></div>
        <div class="certificate-actions">
            <a id="certificate-download-btn" href="#" download class="btn btn-success">
                <i class="fas fa-download me-2"></i>Download Certificate
            </a>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Auth flag for JS logic
const IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};
const CHAT_PET_ID = {{ pet.id }};
const CHAT_SELLER_ID = {{ pet.seller.id }};
const CHAT_SELLER_NAME = "{{ pet.seller.get_full_name|default:pet.seller.username|escapejs }}";

// Global variables
var map;
var petMarker;
var userMarker;
var routeLine;
var userLocation = null;

// Pet location
const petLat = {{ pet.latitude|default:"27.7172" }};
const petLng = {{ pet.longitude|default:"85.3240" }};

// Image gallery arrays
const allImages = [
    {% if pet.image %}"{{ pet.image.url }}"{% endif %}
    {% if pet.image2 %},"{{ pet.image2.url }}"{% endif %}
    {% if pet.image3 %},"{{ pet.image3.url }}"{% endif %}
];
let currentLightboxIndex = 0;

function changeMainImage(src, index) {
    const mainImage = document.getElementById('main-image');
    if (mainImage) {
        mainImage.src = src;
        document.getElementById('current-image-number').textContent = index + 1;
    }
}

function openLightbox(index) {
    currentLightboxIndex = index;
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const counter = document.getElementById('lightbox-counter');
    
    if (lightbox && lightboxImg) {
        lightboxImg.src = allImages[currentLightboxIndex];
        counter.textContent = `${currentLightboxIndex + 1} / ${allImages.length}`;
        lightbox.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function closeLightbox(event) {
    if (event.target.id === 'lightbox' || event.target.className === 'lightbox-close') {
        const lightbox = document.getElementById('lightbox');
        if (lightbox) {
            lightbox.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
}

function changeLightboxImage(direction) {
    currentLightboxIndex += direction;
    
    if (currentLightboxIndex >= allImages.length) {
        currentLightboxIndex = 0;
    } else if (currentLightboxIndex < 0) {
        currentLightboxIndex = allImages.length - 1;
    }
    
    const lightboxImg = document.getElementById('lightbox-img');
    const counter = document.getElementById('lightbox-counter');
    
    if (lightboxImg) {
        lightboxImg.src = allImages[currentLightboxIndex];
        counter.textContent = `${currentLightboxIndex + 1} / ${allImages.length}`;
    }
}

// Keyboard navigation for lightbox
document.addEventListener('keydown', function(event) {
    const lightbox = document.getElementById('lightbox');
    const certificateModal = document.getElementById('certificate-modal');
    
    if (lightbox && lightbox.style.display === 'flex') {
        if (event.key === 'ArrowLeft') {
            changeLightboxImage(-1);
        } else if (event.key === 'ArrowRight') {
            changeLightboxImage(1);
        } else if (event.key === 'Escape') {
            closeLightbox({target: lightbox});
        }
    }
    
    if (certificateModal && certificateModal.style.display === 'flex') {
        if (event.key === 'Escape') {
            closeCertificateModal({target: certificateModal});
        }
    }
});

// Health Certificate Viewer Functions
function viewHealthCertificate(fileUrl) {
    const modal = document.getElementById('certificate-modal');
    const viewer = document.getElementById('certificate-viewer');
    const downloadBtn = document.getElementById('certificate-download-btn');
    
    if (!modal || !viewer) return;
    
    // Set download button URL
    downloadBtn.href = fileUrl;
    
    // Clear previous content
    viewer.innerHTML = '';
    
    // Detect file type
    const fileExtension = fileUrl.split('.').pop().toLowerCase();
    
    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'avif'].includes(fileExtension)) {
        // Display image
        const img = document.createElement('img');
        img.src = fileUrl;
        img.alt = 'Health Certificate';
        img.style.maxWidth = '100%';
        img.style.maxHeight = '70vh';
        img.style.objectFit = 'contain';
        viewer.appendChild(img);
    } else if (fileExtension === 'pdf') {
        // Display PDF
        const iframe = document.createElement('iframe');
        iframe.src = fileUrl;
        iframe.style.width = '100%';
        iframe.style.height = '70vh';
        iframe.style.border = 'none';
        viewer.appendChild(iframe);
    } else {
        // Unsupported format
        viewer.innerHTML = '<p class="text-center"><i class="fas fa-file me-2"></i>Preview not available. Please download to view.</p>';
    }
    
    // Show modal
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeCertificateModal(event) {
    if (event.target.id === 'certificate-modal' || event.target.className === 'lightbox-close') {
        const modal = document.getElementById('certificate-modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
}

function contactSeller() {
    if (!IS_AUTHENTICATED) {
        window.location.href = "{% url 'login' %}?next={{ request.path }}";
        return;
    }

    const chatModalEl = document.getElementById('chatModal');
    const chatForm = document.getElementById('chat-form');
    const chatTitle = document.getElementById('chatModalLabel');
    const chatSubtitle = document.getElementById('chatModalSubtitle');
    const convoTitle = document.getElementById('chatConversationTitle');
    const convoSubtitle = document.getElementById('chatConversationSubtitle');

    if (!chatModalEl || !chatForm) {
        return;
    }

    // Attach context for chat.js to use
    chatForm.dataset.petId = CHAT_PET_ID;
    chatForm.dataset.sellerId = CHAT_SELLER_ID;
    chatForm.dataset.context = 'marketplace_pet';

    if (chatTitle) {
        chatTitle.textContent = `Chat with ${CHAT_SELLER_NAME}`;
    }
    if (chatSubtitle) {
        chatSubtitle.textContent = 'Discuss this pet, price and meetup details directly with the seller.';
    }
    if (convoTitle) {
        convoTitle.textContent = `Marketplace chat • {{ pet.breed.name }}`;
    }
    if (convoSubtitle) {
        convoSubtitle.textContent = 'Messages are private between you and the seller.';
    }

    // Clear previous messages UI and show loading
    const messagesEl = document.getElementById('chat-messages');
    if (messagesEl) {
        messagesEl.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    }

    // IMPORTANT: Stop any existing polling before starting new chat context
    if (window.PetBuddyChat && window.PetBuddyChat.stopPolling) {
        window.PetBuddyChat.stopPolling();
    }

    // Load existing messages for this pet before opening modal
    fetch(`/chat/messages/?pet_id=${CHAT_PET_ID}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && messagesEl) {
                messagesEl.innerHTML = '';
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message-row ${msg.is_self ? 'self' : ''}`;
                        
                        if (!msg.is_self) {
                            messageDiv.innerHTML = `
                                <div class="chat-message-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                            `;
                        }
                        
                        const bubbleDiv = document.createElement('div');
                        bubbleDiv.className = 'chat-message-bubble';
                        bubbleDiv.innerHTML = `
                            <div class="chat-message-meta">
                                <span class="chat-message-author">${msg.is_self ? 'You' : msg.sender_name}</span>
                                <span class="chat-message-time">${msg.created_at}</span>
                            </div>
                            <div class="chat-message-text">${msg.text}</div>
                        `;
                        
                        messageDiv.appendChild(bubbleDiv);
                        messagesEl.appendChild(messageDiv);
                    });
                    
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                    
                    // CRITICAL: Set the lastMessageId to prevent duplicate loading
                    if (window.PetBuddyChat && data.last_id) {
                        window.PetBuddyChat.setLastMessageId(data.last_id);
                    }
                } else {
                    messagesEl.innerHTML = `
                        <div class="chat-empty-state">
                            <i class="fas fa-comment-dots mb-3"></i>
                            <h6>Start the conversation</h6>
                            <p class="mb-0">Send a message to inquire about this pet</p>
                        </div>
                    `;
                }
                
                // Open modal first, then start polling
                const modal = new bootstrap.Modal(chatModalEl);
                modal.show();
                
                // Start polling for NEW messages only
                if (window.PetBuddyChat && typeof window.PetBuddyChat.startForCurrentContext === 'function') {
                    window.PetBuddyChat.startForCurrentContext();
                }
            }
        })
        .catch(error => {
            console.error('Error loading chat:', error);
            if (messagesEl) {
                messagesEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading chat. Please try again.
                    </div>
                `;
            }
        });
}

// Calculate distance between two points (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    return distance;
}

// Show route from user location to pet location using OSRM
function showRoute() {
    if (navigator.geolocation) {
        showMessage('Getting your location...', 'info');
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Remove existing user marker and route if any
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                if (routeLine) {
                    map.removeLayer(routeLine);
                }
                
                // Add user location marker (blue)
                var userIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                
                userMarker = L.marker([userLocation.lat, userLocation.lng], {icon: userIcon})
                    .addTo(map)
                    .bindPopup('<strong>Your Location</strong>')
                    .openPopup();
                
                // Fetch route from OSRM API
                showMessage('Calculating route...', 'info');
                
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${userLocation.lng},${userLocation.lat};${petLng},${petLat}?overview=full&geometries=geojson&steps=true`;
                
                fetch(osrmUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const coordinates = route.geometry.coordinates;
                            
                            // Convert coordinates from [lng, lat] to [lat, lng] for Leaflet
                            const latlngs = coordinates.map(coord => [coord[1], coord[0]]);
                            
                            // Draw the route line following actual roads
                            routeLine = L.polyline(latlngs, {
                                color: '#007bff',
                                weight: 5,
                                opacity: 0.8,
                                lineJoin: 'round',
                                lineCap: 'round'
                            }).addTo(map);
                            
                            // Add a subtle outline for better visibility
                            var routeOutline = L.polyline(latlngs, {
                                color: '#ffffff',
                                weight: 7,
                                opacity: 0.5,
                                lineJoin: 'round',
                                lineCap: 'round'
                            }).addTo(map);
                            
                            // Move outline behind the main route
                            routeOutline.bringToBack();
                            
                            // Fit map to show the entire route
                            map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                            
                            // Display distance and duration
                            const distanceKm = (route.distance / 1000).toFixed(2);
                            const distanceMiles = (distanceKm * 0.621371).toFixed(2);
                            const durationMinutes = Math.round(route.duration / 60);
                            const durationHours = Math.floor(durationMinutes / 60);
                            const durationMins = durationMinutes % 60;
                            
                            const distanceInfo = document.getElementById('distance-info');
                            const distanceText = document.getElementById('distance-text');
                            const durationInfo = document.getElementById('duration-info');
                            const durationText = document.getElementById('duration-text');
                            
                            if (distanceInfo && distanceText) {
                                distanceText.innerHTML = '<strong>Distance:</strong> ' + distanceKm + ' km (' + distanceMiles + ' miles)';
                                distanceInfo.style.display = 'flex';
                            }
                            
                            if (durationInfo && durationText) {
                                let durationStr = '<strong>Duration:</strong> ';
                                if (durationHours > 0) {
                                    durationStr += durationHours + ' hr ' + durationMins + ' min';
                                } else {
                                    durationStr += durationMins + ' min';
                                }
                                durationText.innerHTML = durationStr;
                                durationInfo.style.display = 'flex';
                            }
                            
                            showMessage('Route calculated successfully!', 'success');
                        } else {
                            // Fallback to straight line if routing fails
                            console.warn('OSRM routing failed, using straight line');
                            drawStraightLine(userLocation.lat, userLocation.lng);
                        }
                    })
                    .catch(error => {
                        console.error('Routing error:', error);
                        showMessage('Could not calculate route. Showing straight line.', 'warning');
                        drawStraightLine(userLocation.lat, userLocation.lng);
                    });
            },
            function(error) {
                console.error('Geolocation error:', error);
                showMessage('Could not get your location. Please enable location services.', 'error');
            }
        );
    } else {
        showMessage('Geolocation is not supported by your browser', 'error');
    }
}

// Fallback function to draw straight line
function drawStraightLine(lat, lng) {
    var latlngs = [
        [lat, lng],
        [petLat, petLng]
    ];
    
    routeLine = L.polyline(latlngs, {
        color: '#007bff',
        weight: 4,
        opacity: 0.7,
        dashArray: '10, 10',
        lineJoin: 'round'
    }).addTo(map);
    
    // Fit map to show both markers
    var bounds = L.latLngBounds([
        [lat, lng],
        [petLat, petLng]
    ]);
    map.fitBounds(bounds, {padding: [50, 50]});
    
    // Calculate and display straight-line distance
    var distance = calculateDistance(lat, lng, petLat, petLng);
    var distanceInfo = document.getElementById('distance-info');
    var distanceText = document.getElementById('distance-text');
    
    if (distanceInfo && distanceText) {
        distanceText.innerHTML = '<strong>Straight-line Distance:</strong> ' + distance.toFixed(2) + ' km (' + (distance * 0.621371).toFixed(2) + ' miles)';
        distanceInfo.style.display = 'flex';
    }
}

// Clear route and user marker
function clearRoute() {
    if (userMarker) {
        map.removeLayer(userMarker);
        userMarker = null;
    }
    if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
    }
    
    // Remove all polylines (including outline)
    map.eachLayer(function(layer) {
        if (layer instanceof L.Polyline && layer !== routeLine) {
            map.removeLayer(layer);
        }
    });
    
    // Hide distance and duration info
    var distanceInfo = document.getElementById('distance-info');
    var durationInfo = document.getElementById('duration-info');
    
    if (distanceInfo) {
        distanceInfo.style.display = 'none';
    }
    if (durationInfo) {
        durationInfo.style.display = 'none';
    }
    
    // Reset map view to pet location
    map.setView([petLat, petLng], 13);
    
    showMessage('Route cleared', 'info');
}

// Show message to user
function showMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Initialize location map
document.addEventListener('DOMContentLoaded', function() {
    map = L.map('location-map').setView([petLat, petLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
        subdomains: ['a', 'b', 'c']
    }).addTo(map);
    
    // Add pet location marker (red)
    var petIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    petMarker = L.marker([petLat, petLng], {icon: petIcon})
        .addTo(map)
        .bindPopup('<strong>Pet Location</strong><br>{{ pet.city }}, {{ pet.state }}');
});
</script>
{% endblock %}
