{% extends 'base.html' %}
{% load static %}

{% block title %}{{ pet.breed.name }} - Pet Details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/pet_detail.css' %}">
{% endblock %}

{% block content %}
<div class="container pt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'browse_pets' %}">Browse Pets</a></li>
            <li class="breadcrumb-item active">{{ pet.breed.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Pet Images -->
        <div class="col-lg-6">
            <div class="pet-images">
                <div class="main-image-container mb-3" onclick="openLightbox(0)">
                    {% if pet.image %}
                        <img src="{{ pet.image.url }}" alt="{{ pet.breed.name }}" class="main-pet-image" data-index="0">
                    {% else %}
                        <img src="{% static 'img/default-pet.jpg' %}" alt="No image" class="main-pet-image" data-index="0">
                    {% endif %}
                    <div class="image-count-indicator">
                        <i class="fas fa-images"></i>
                        <span id="current-image-number">1</span> / <span id="total-images">{% if pet.image3 %}3{% elif pet.image2 %}2{% else %}1{% endif %}</span>
                    </div>
                </div>
                
                <!-- Additional Images -->
                <div class="additional-images d-flex gap-2">
                    {% if pet.image %}
                        <div class="additional-image-container" onclick="changeMainImage('{{ pet.image.url }}', 0)">
                            <img src="{{ pet.image.url }}" alt="{{ pet.breed.name }}" class="additional-image" data-index="0">
                        </div>
                    {% endif %}
                    {% if pet.image2 %}
                        <div class="additional-image-container" onclick="changeMainImage('{{ pet.image2.url }}', 1)">
                            <img src="{{ pet.image2.url }}" alt="{{ pet.breed.name }}" class="additional-image" data-index="1">
                        </div>
                    {% endif %}
                    {% if pet.image3 %}
                        <div class="additional-image-container" onclick="changeMainImage('{{ pet.image3.url }}', 2)">
                            <img src="{{ pet.image3.url }}" alt="{{ pet.breed.name }}" class="additional-image" data-index="2">
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pet Details -->
        <div class="col-lg-6">
            <div class="pet-info">
                <!-- Pet Name and Status -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 class="pet-name">{{ pet.breed.name }}</h1>
                    <div class="pet-badges">
                        <span class="badge bg-success">{{ pet.get_status_display }}</span>
                    </div>
                </div>

                <!-- Listed Date -->
                <div class="listing-date mb-3">
                    {% load humanize %}
                    {% if pet.created_at %}
                        {% now "U" as current_timestamp %}
                        {% if pet.created_at|timesince|slice:":1" == "0" or pet.created_at|timesince == "0 minutes" %}
                            <span class="badge bg-info listing-badge">
                                <i class="fas fa-star me-1"></i>New Listing
                            </span>
                        {% else %}
                            <span class="text-muted listing-text">
                                <i class="far fa-clock me-1"></i>Listed {{ pet.created_at|timesince }} ago
                            </span>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Price -->
                {% if pet.price %}
                <div class="pet-price mb-3">
                    <h3 class="text-primary">NPR {{ pet.price }}</h3>
                </div>
                {% endif %}

                <!-- Basic Info -->
                <div class="pet-basic-info mb-4">
                    <div class="row">
                        <div class="col-6">
                            <div class="info-item">
                                <i class="fas fa-paw text-muted"></i>
                                <span class="label">Breed:</span>
                                <span class="value">{{ pet.breed.name }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="info-item">
                                {% if pet.gender_availability %}
                                    {% if pet.gender_availability == 'male' %}
                                        <i class="fas fa-mars text-primary"></i>
                                        <span class="label">Gender:</span>
                                        <span class="value">male available</span>
                                    {% elif pet.gender_availability == 'female' %}
                                        <i class="fas fa-venus" style="color: #e91e63;"></i>
                                        <span class="label">Gender:</span>
                                        <span class="value">Female available</span>
                                    {% elif pet.gender_availability == 'both' %}
                                        <i class="fas fa-venus-mars text-primary"></i>
                                        <span class="label">Gender:</span>
                                        <span class="value">Both available</span>
                                    {% endif %}
                                {% else %}
                                    {% if pet.gender == 'male' %}
                                        <i class="fas fa-mars text-primary"></i>
                                    {% else %}
                                        <i class="fas fa-venus" style="color: #e91e63;"></i>
                                    {% endif %}
                                    <span class="label">Gender:</span>
                                    <span class="value">{{ pet.get_gender_display }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="info-item">
                                <i class="fas fa-birthday-cake text-muted"></i>
                                <span class="label">Age:</span>
                                <span class="value">{{ pet.age }}</span>
                            </div>
                        </div>
                        {% if pet.weight %}
                        <div class="col-6">
                            <div class="info-item">
                                <i class="fas fa-weight text-muted"></i>
                                <span class="label">Weight:</span>
                                <span class="value">{{ pet.weight }} lbs</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if pet.color %}
                        <div class="col-6">
                            <div class="info-item">
                                <i class="fas fa-palette text-muted"></i>
                                <span class="label">Color:</span>
                                <span class="value">{{ pet.color }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Health Info -->
                <div class="pet-health-info mb-4">
                    <h5>Health Information</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="info-item">
                                <i class="fas fa-syringe {% if pet.vaccination_status %}text-success{% else %}text-muted{% endif %}"></i>
                                <span class="label">Vaccination:</span>
                                <span class="value {% if pet.vaccination_status %}text-success{% else %}text-muted{% endif %}">
                                    {% if pet.vaccination_status %}Vaccinated{% else %}Not Vaccinated{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="info-item">
                                <i class="fas fa-certificate {% if pet.health_certificate %}text-success{% else %}text-muted{% endif %}"></i>
                                <span class="label">Health Certificate:</span>
                                {% if pet.health_certificate %}
                                    {% if pet.health_certificate_file %}
                                        <button onclick="viewHealthCertificate('{{ pet.health_certificate_file.url }}')" class="value text-success text-decoration-none health-cert-link btn btn-link p-0">
                                            <i class="fas fa-eye me-1"></i>View Certificate
                                        </button>
                                    {% else %}
                                        <span class="value text-success">Available (Contact Seller)</span>
                                    {% endif %}
                                {% else %}
                                    <span class="value text-muted">Not Available</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Seller -->
                <div class="contact-seller mb-4">
                    <h5>Interested in this pet?</h5>
                    <p class="text-muted mb-3">
                        <i class="fas fa-map-marker-alt me-2"></i>{{ pet.city }}{% if pet.state %}, {{ pet.state }}{% endif %}
                    </p>
                    <div class="contact-buttons mt-3">
                        <button class="btn btn-primary btn-lg w-100" onclick="openChatWithSeller({{ pet.id }}, '{{ pet.breed.name }}')">
                            <i class="fas fa-comments me-2"></i>Contact Seller
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pet Description -->
    {% if pet.description %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="pet-description">
                <h4>About this {{ pet.breed.name }}</h4>
                <p class="description-text">{{ pet.description|linebreaks }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Related Pets -->
    {% if related_pets %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="related-pets-header mb-4">
                <h4 class="related-pets-title">
                    <i class="fas fa-paw me-2"></i>You Might Also Like
                </h4>
                <p class="related-pets-subtitle text-muted">Similar {{ pet.breed.name }} pets available for adoption</p>
            </div>
            <div class="row">
                {% for related_pet in related_pets %}
                <div class="col-md-3 mb-4">
                    <div class="card pet-card h-100">
                        <div class="card-img-container">
                            {% if related_pet.image %}
                                <img src="{{ related_pet.image.url }}" class="card-img-top" alt="{{ related_pet.breed.name }}">
                            {% else %}
                                <img src="{% static 'images/default-pet.jpg' %}" class="card-img-top" alt="No image">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ related_pet.breed.name }}</h5>
                            <p class="card-text text-muted">{{ related_pet.breed.name }} â€¢ {{ related_pet.age }}</p>
                            {% if related_pet.price %}
                                <p class="card-text"><strong class="text-primary">NPR {{ related_pet.price }}</strong></p>
                            {% endif %}
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{% url 'pet_detail' related_pet.pk %}" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Lightbox Modal -->
<div class="lightbox" id="lightbox">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <span class="lightbox-nav lightbox-prev" onclick="changeImage(-1)">&#10094;</span>
    <div class="lightbox-content">
        <img class="lightbox-image" id="lightbox-img" src="" alt="Pet Image">
    </div>
    <span class="lightbox-nav lightbox-next" onclick="changeImage(1)">&#10095;</span>
    <div class="lightbox-counter" id="lightbox-counter"></div>
</div>

<!-- Health Certificate Modal -->
<div class="lightbox" id="certificate-modal">
    <span class="lightbox-close" onclick="closeCertificateModal()">&times;</span>
    <div class="lightbox-content certificate-content">
        <div class="certificate-header">
            <h4><i class="fas fa-certificate me-2"></i>Health Certificate</h4>
            <a id="cert-download-btn" href="" download class="btn btn-light btn-sm">
                <i class="fas fa-download me-1"></i>Download
            </a>
        </div>
        <div class="certificate-viewer">
            <img id="certificate-img" src="" alt="Health Certificate" style="display: none;">
            <iframe id="certificate-pdf" src="" style="display: none;"></iframe>
        </div>
    </div>
</div>

<script>
// Image gallery array
const petImages = [
    {% if pet.image %}'{{ pet.image.url }}'{% endif %}
    {% if pet.image2 %}, '{{ pet.image2.url }}'{% endif %}
    {% if pet.image3 %}, '{{ pet.image3.url }}'{% endif %}
];

let currentImageIndex = 0;

function changeMainImage(src, index) {
    document.querySelector('.main-pet-image').src = src;
    currentImageIndex = index;
    // Update the image count indicator
    document.getElementById('current-image-number').textContent = index + 1;
}

function openLightbox(index) {
    currentImageIndex = index;
    updateLightboxImage();
    document.getElementById('lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.body.style.overflow = 'auto';
}

function changeImage(direction) {
    currentImageIndex += direction;
    
    if (currentImageIndex >= petImages.length) {
        currentImageIndex = 0;
    } else if (currentImageIndex < 0) {
        currentImageIndex = petImages.length - 1;
    }
    
    updateLightboxImage();
}

function updateLightboxImage() {
    const lightboxImg = document.getElementById('lightbox-img');
    const counter = document.getElementById('lightbox-counter');
    
    lightboxImg.src = petImages[currentImageIndex];
    counter.textContent = `${currentImageIndex + 1} / ${petImages.length}`;
}

// Close lightbox on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLightbox();
    } else if (e.key === 'ArrowLeft') {
        changeImage(-1);
    } else if (e.key === 'ArrowRight') {
        changeImage(1);
    }
});

// Close lightbox when clicking outside image
document.getElementById('lightbox').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLightbox();
    }
});

// Replace the openChatWithSeller function in pet_detail.html with this:

function openChatWithSeller(petId, petName) {
    {% if user.is_authenticated %}
        const petSellerId = {{ pet.seller.id }};
        const petSellerName = "{{ pet.seller.get_full_name|default:pet.seller.username|escapejs }}";
        
        // Open chat modal with pet context
        const chatModal = document.getElementById('chatModal');
        const chatForm = document.getElementById('chat-form');
        const chatTitle = document.getElementById('chatModalLabel');
        const chatSubtitle = document.getElementById('chatModalSubtitle');
        const convoTitle = document.getElementById('chatConversationTitle');
        const convoSubtitle = document.getElementById('chatConversationSubtitle');
        const messagesEl = document.getElementById('chat-messages');
        
        if (!chatModal || !chatForm) {
            alert('Chat system is not available. Please refresh the page.');
            return;
        }
        
        // Set context for this pet
        chatForm.dataset.petId = petId;
        chatForm.dataset.sellerId = petSellerId;
        chatForm.dataset.context = 'browse_pet';
        
        // Update modal titles
        if (chatTitle) {
            chatTitle.textContent = `Chat with ${petSellerName}`;
        }
        if (chatSubtitle) {
            chatSubtitle.textContent = `About ${petName}`;
        }
        if (convoTitle) {
            convoTitle.textContent = petName;
        }
        if (convoSubtitle) {
            convoSubtitle.textContent = 'Messages are private between you and the seller';
        }
        
        // Clear any existing messages first
        messagesEl.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        // IMPORTANT: Stop any existing polling before starting new chat context
        if (window.PetBuddyChat && window.PetBuddyChat.stopPolling) {
            window.PetBuddyChat.stopPolling();
        }
        
        // Load existing messages for this pet (only once during initial load)
        fetch(`/chat/messages/?pet_id=${petId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Clear loading spinner and any old messages
                    messagesEl.innerHTML = '';
                    
                    if (data.messages && data.messages.length > 0) {
                        // Display existing messages
                        data.messages.forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `chat-message-row ${msg.is_self ? 'self' : ''}`;
                            
                            if (!msg.is_self) {
                                messageDiv.innerHTML = `
                                    <div class="chat-message-avatar">
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                `;
                            }
                            
                            const bubbleDiv = document.createElement('div');
                            bubbleDiv.className = 'chat-message-bubble';
                            bubbleDiv.innerHTML = `
                                <div class="chat-message-meta">
                                    <span class="chat-message-author">${msg.is_self ? 'You' : msg.sender_name}</span>
                                    <span class="chat-message-time">${msg.created_at}</span>
                                </div>
                                <div class="chat-message-text">${msg.text}</div>
                            `;
                            
                            messageDiv.appendChild(bubbleDiv);
                            messagesEl.appendChild(messageDiv);
                        });
                        
                        // Scroll to bottom
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                        
                        // CRITICAL: Set the lastMessageId in the global chat system to prevent duplicate loading
                        if (window.PetBuddyChat && data.last_id) {
                            window.PetBuddyChat.setLastMessageId(data.last_id);
                        }
                    } else {
                        // No messages yet - show welcome message
                        messagesEl.innerHTML = `
                            <div class="chat-empty-state">
                                <i class="fas fa-comment-dots mb-3"></i>
                                <h6>Start the conversation</h6>
                                <p class="mb-0">Send a message to inquire about this ${petName}</p>
                            </div>
                        `;
                    }
                    
                    // Open the modal first
                    const modal = new bootstrap.Modal(chatModal);
                    modal.show();
                    
                    // Start polling for NEW messages only (after modal is shown)
                    if (window.PetBuddyChat && typeof window.PetBuddyChat.startForCurrentContext === 'function') {
                        window.PetBuddyChat.startForCurrentContext();
                    }
                } else {
                    messagesEl.innerHTML = `
                        <div class="alert alert-warning">
                            Could not load chat messages. Please try again.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading chat:', error);
                if (messagesEl) {
                    messagesEl.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading chat. Please try again or check your connection.
                        </div>
                    `;
                }
            });
        
    {% else %}
        // Redirect to login
        window.location.href = '{% url "login" %}?next={{ request.path }}';
    {% endif %}
}

// Health Certificate Modal Functions
function viewHealthCertificate(fileUrl) {
    const modal = document.getElementById('certificate-modal');
    const downloadBtn = document.getElementById('cert-download-btn');
    const imgViewer = document.getElementById('certificate-img');
    const pdfViewer = document.getElementById('certificate-pdf');
    
    // Set download link
    downloadBtn.href = fileUrl;
    
    // Check file type and display accordingly
    const fileExtension = fileUrl.split('.').pop().toLowerCase();
    
    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'avif'].includes(fileExtension)) {
        // Display as image
        imgViewer.src = fileUrl;
        imgViewer.style.display = 'block';
        pdfViewer.style.display = 'none';
    } else if (fileExtension === 'pdf') {
        // Display PDF in iframe
        pdfViewer.src = fileUrl;
        pdfViewer.style.display = 'block';
        imgViewer.style.display = 'none';
    } else {
        // For other file types, just download
        window.open(fileUrl, '_blank');
        return;
    }
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeCertificateModal() {
    const modal = document.getElementById('certificate-modal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
}

// Close certificate modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCertificateModal();
    }
});

// Close certificate modal when clicking outside
document.getElementById('certificate-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCertificateModal();
    }
});
</script>
{% endblock %}
